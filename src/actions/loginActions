import {
  AUTH_USER,
  AUTH_ERROR,
} from '../constants/constants';
import { history } from '../history';
import * as constants from '../constants/constants'
import * as helpers from '../helpers/helpers'
import axios from 'axios'

export function signinUser ({username, password}) {
  return function (dispatch) {

      axios.post(`${constants.TEST_ROOT_URL}/login`, {username, password})
          .then(response => {
              let jsonDataToken = response.data.split(': ')[1].split(',')[0]
              let jsonDataId = response.data.split('=')[1].split(',')[0]
              helpers.setToken(jsonDataToken)
              helpers.setId(jsonDataId)
              return jsonDataId
                })
          .then((jsonDataId) => {
              console.log(jsonDataId)
              let token = helpers.getToken()
              axios.get(`${constants.ROOT_URL}/users/${jsonDataId}`,
                  {
                      headers: {Authorization: 'Bearer ' + token}
                  })
              .then(response => {
                  console.log(response)
                  document.body.classList.remove(constants.MODAL_OPEN_CLASS);
                  if (response.status === 200) {
                  dispatch(authSuccess(response.data))
                  history.push(`/profile/${response.data.id}`)
                  }
                  else if (response.status === 401) {
                      dispatch(authError('Проверьте правильность заполненных данных'))
                  }
                  })
          })
          .catch((err) => {
            console.log(err)
      })
  }
}

export function authError(error) {
    return {
        type: AUTH_ERROR,
        payload: error
    };
}

export function authSuccess(success) {
    return {
        type: AUTH_USER,
        payload: success
    };
}

